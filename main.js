(()=>{"use strict";var t=document.querySelector("#card-template").content;function e(t){t.classList.toggle("card__like-button_is-active")}function n(t){t.classList.add("popup_is-opened"),document.addEventListener("keydown",r)}function o(){var t=document.querySelector(".popup_is-opened");t&&t.classList.remove("popup_is-opened"),document.removeEventListener("keydown",r)}function r(t){"Escape"===t.key&&o()}function c(t){t.querySelector(".popup__close").addEventListener("click",(function(t){o()}))}function a(t){t.addEventListener("click",(function(t){t.currentTarget===t.target&&o()}))}var i={},u=function(t,e){i=e;var n=Array.from(t.querySelectorAll(i.inputSelector)),o=t.querySelector(i.submitButtonSelector);f(n,o),n.forEach((function(e){l(t,e),f(n,o)}))},s=function(t){return t.some((function(t){return!t.validity.valid}))},l=function(t,e){var n=t.querySelector(".".concat(e.id,"-error"));e.classList.remove(i.inputErrorClass),n.classList.remove(i.errorClass),n.textContent=""},d=function(t){var e=Array.from(t.querySelectorAll(i.inputSelector)),n=t.querySelector(i.submitButtonSelector);f(e,n),e.forEach((function(o){o.addEventListener("input",(function(){!function(t,e){e.validity.patternMismatch?e.setCustomValidity(e.dataset.errorMessage):e.setCustomValidity(""),e.validity.valid?l(t,e):function(t,e,n){var o=t.querySelector(".".concat(e.id,"-error"));e.classList.add(i.inputErrorClass),o.textContent=n,o.classList.add(i.errorClass)}(t,e,e.validationMessage)}(t,o),f(e,n)}))}))};function f(t,e){s(t)?(e.disabled=!0,e.classList.add(i.inactiveButtonClass)):(e.disabled=!1,e.classList.remove(i.inactiveButtonClass))}var p,m={baseUrl:"https://nomoreparties.co/v1/wff-cohort-13",headers:{authorization:"5689d6c7-8220-42a1-ba34-44843757f0e3","Content-Type":"application/json"}},_=document.querySelector(".places__list"),v=document.querySelector(".popup_type_image"),h=v.querySelector(".popup__image"),y=v.querySelector(".popup__caption"),S=document.querySelector(".popup_type_new-card"),g=document.querySelector(".popup_type_edit"),b=document.querySelector(".popup_type_update"),k=document.querySelector(".popup_type_delete-card"),C=document.querySelector(".profile__info"),q=document.querySelector(".profile__image"),E=document.forms["new-place"],L=document.forms["edit-profile"],x=document.forms["update-avatar"],j=document.forms["delete-card"],A={formSelector:".popup__form",inputSelector:".popup__input",submitButtonSelector:".popup__button",inactiveButtonClass:"popup__button_inactive",inputErrorClass:"popup__input-error",errorClass:"popup__span-error_active"},D="",P="Сохранить",B="Сохранение...";function I(n,o,r,c){_.prepend(function(n,o,r,c,a){var i=t.querySelector(".places__item").cloneNode(!0),u=i.querySelector(".card__image");u.setAttribute("src",n.link),u.setAttribute("alt",n.name),u.addEventListener("click",c);var s=i.querySelector(".card__delete-button");n.owner._id===a?s.addEventListener("click",o):s.style.display="none",i.querySelector(".card__title").textContent=n.name;var l=i.querySelector(".card__like-button");return l.addEventListener("click",r),n.likes.some((function(t){return t._id===a}))&&e(l),i.querySelector(".card__like-count").textContent=n.likes.length,i.setAttribute("data-id",n._id),i}(n,o,r,c,D))}function T(t,e){t.addEventListener("submit",e)}function U(t,e){document.querySelector(e).addEventListener("click",(function(e){E.reset(),u(E,A),n(t)}))}function w(){return{editInputName:L.elements.name,editInputDescription:L.elements.description}}function N(){return{infoTitle:C.querySelector(".profile__title"),infoDescription:C.querySelector(".profile__description")}}function O(t){var e=t.target.getAttribute("src"),o=t.target.getAttribute("alt");h.setAttribute("src",e),h.setAttribute("alt",o),y.textContent=o,n(v)}function J(t){var e=H(t);k.setAttribute("data-id",e),n(k)}function M(t){var n=H(t),o=t.target,r=function(t){e(o),o.closest(".card__like").querySelector(".card__like-count").textContent=t.likes.length};t.target.classList.contains("card__like-button_is-active")?function(t){return fetch("".concat(m.baseUrl,"/cards/likes/").concat(t),{headers:m.headers,method:"DELETE"}).then((function(t){return t.ok?t.json():Promise.reject("Ошибка: ".concat(t.status))}))}(n).then((function(t){r(t)})).catch((function(t){console.log(t)})):function(t){return fetch("".concat(m.baseUrl,"/cards/likes/").concat(t),{headers:m.headers,method:"PUT"}).then((function(t){return t.ok?t.json():Promise.reject("Ошибка: ".concat(t.status))}))}(n).then((function(t){r(t)})).catch((function(t){console.log(t)}))}function H(t){return t.target.closest(".places__item").dataset.id}!function(t){i=t,Array.from(document.querySelectorAll(i.formSelector)).forEach((function(t){d(t)}))}(A),Promise.all([fetch("".concat(m.baseUrl,"/users/me"),{headers:m.headers}).then((function(t){return t.ok?t.json():Promise.reject("Ошибка: ".concat(t.status))})),fetch("".concat(m.baseUrl,"/cards"),{headers:m.headers}).then((function(t){return t.ok?t.json():Promise.reject("Ошибка: ".concat(t.status))}))]).then((function(t){var e=t[0],n=N();n.infoDescription.textContent=e.about,n.infoTitle.textContent=e.name,q.style.backgroundImage='url("'.concat(e.avatar,'")'),D=e._id,t[1].forEach((function(t){I(t,J,M,O)}))})).catch((function(t){console.log(t)})),q.addEventListener("click",(function(t){var e=getComputedStyle(t.target,"::after"),o=getComputedStyle(t.target),r=parseInt(e.width),c=parseInt(e.height),a=parseInt(o.width),i=parseInt(o.height),s=t.clientX-t.target.getBoundingClientRect().left,l=t.clientY-t.target.getBoundingClientRect().top,d=a/2,f=r/2,p=i/2,m=c/2;d-f<s&&s<=d+f&&p-m<l&&l<=p+m&&(x.reset(),u(x,A),n(b))})),c(v),a(v),c(b),a(b),c(S),a(S),U(S,".profile__add-button"),c(k),a(k),U(S,".profile__add-button"),c(g),a(g),p=g,document.querySelector(".profile__edit-button").addEventListener("click",(function(t){var e,o;e=w(),o=N(),e.editInputDescription.value=o.infoDescription.textContent,e.editInputName.value=o.infoTitle.textContent,u(L,A),n(p)})),T(L,(function(t){t.preventDefault();var e=w(),n=t.target.querySelector(A.submitButtonSelector),r={name:e.editInputName.value,about:e.editInputDescription.value};n.textContent=B,function(t){return fetch("".concat(m.baseUrl,"/users/me"),{headers:m.headers,method:"PATCH",body:JSON.stringify({name:t.name,about:t.about})}).then((function(t){return t.ok?t.json():Promise.reject("Ошибка: ".concat(t.status))}))}(r).then((function(t){var e=N();e.infoDescription.textContent=t.about,e.infoTitle.textContent=t.name})).finally((function(){o(),n.textContent=P})).catch((function(t){console.log(t)}))})),T(E,(function(t){t.preventDefault();var e=t.target,n=e.elements["place-name"],r=e.elements.link,c=t.target.querySelector(A.submitButtonSelector);c.textContent=B,function(t){return fetch("".concat(m.baseUrl,"/cards"),{headers:m.headers,method:"POST",body:JSON.stringify({name:t.name,link:t.link})}).then((function(t){return t.ok?t.json():Promise.reject("Ошибка: ".concat(t.status))}))}({name:n.value,link:r.value,alt:n.value}).then((function(t){I(t,J,M,O)})).finally((function(){o(),c.textContent=P})).catch((function(t){console.log(t)}))})),T(x,(function(t){t.preventDefault();var e=t.target.elements.link,n=t.target.querySelector(A.submitButtonSelector);n.textContent=B,function(t){return fetch("".concat(m.baseUrl,"/users/me/avatar"),{headers:m.headers,method:"PATCH",body:JSON.stringify({avatar:t})}).then((function(t){return t.ok?t.json():Promise.reject("Ошибка: ".concat(t.status))}))}(e.value).then((function(t){q.style.backgroundImage='url("'.concat(t.avatar,'")')})).finally((function(){o(),n.textContent=P})).catch((function(t){console.log(t)}))})),T(j,(function(t){t.preventDefault();var e=k.dataset.id,n=_.querySelector("[data-id='".concat(e,"']")),r=t.target.querySelector(A.submitButtonSelector);r.textContent="Удаление...",function(t){return fetch("".concat(m.baseUrl,"/cards/").concat(t),{headers:m.headers,method:"DELETE"}).then((function(t){return t.ok?t.json():Promise.reject("Ошибка: ".concat(t.status))}))}(e).then((function(t){n.closest(".places__item").remove(),o()})).finally((function(){o(),r.textContent="Да"})).catch((function(t){console.log(t)}))}))})();